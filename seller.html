<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Dashboard - HomeMade Eats</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Auth Container (Visible if not logged in) -->
    <div id="authContainer" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-md w-full max-w-md">
            <div class="text-center mb-6">
                <span class="text-4xl">üë©‚Äçüç≥</span>
                <h2 class="text-2xl font-bold mt-2 text-gray-800">Seller Login</h2>
                <p class="text-gray-500 text-sm">Manage your kitchen</p>
            </div>
            
            <form id="authForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="authEmail" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="authPassword" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500">
                </div>
                <div class="flex gap-2">
                    <button type="button" onclick="handleLogin()" class="flex-1 bg-orange-600 text-white py-2 rounded-lg font-semibold hover:bg-orange-700 transition">Login</button>
                    <button type="button" onclick="handleSignUp()" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg font-semibold hover:bg-gray-300 transition">Sign Up</button>
                </div>
            </form>
            <p id="authError" class="text-red-500 text-sm mt-4 text-center hidden"></p>
            <div class="mt-6 text-center">
                <a href="index.html" class="text-sm text-orange-600 hover:underline">‚Üê Back to Shop</a>
            </div>
        </div>
    </div>

    <!-- App Container (Visible if logged in) -->
    <div id="appContainer" class="hidden">
        <!-- Top Nav -->
        <nav class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                <h1 class="font-bold text-xl text-gray-800">My Kitchen Dashboard</h1>
                <div class="flex items-center gap-4">
                    <span id="userEmail" class="text-sm text-gray-600 hidden sm:block"></span>
                    <button onclick="handleLogout()" class="text-sm bg-red-50 text-red-600 px-3 py-1 rounded-md hover:bg-red-100 transition">Logout</button>
                </div>
            </div>
        </nav>

        <!-- Main Grid -->
        <div class="max-w-7xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
            
            <!-- Left Column: Add New Listing -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <span>‚ûï</span> Add New Dish
                    </h2>
                    <form id="listingForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Dish Name</label>
                            <input type="text" name="title" required class="w-full border-gray-300 rounded-lg border p-2 focus:ring-orange-500 focus:border-orange-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Price ($)</label>
                            <input type="number" step="0.01" name="price" required class="w-full border-gray-300 rounded-lg border p-2 focus:ring-orange-500 focus:border-orange-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea name="description" rows="3" class="w-full border-gray-300 rounded-lg border p-2 focus:ring-orange-500 focus:border-orange-500"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Image</label>
                            <input type="file" id="foodImage" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100"/>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" name="is_available" id="isAvailable" checked class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded">
                            <label for="isAvailable" class="text-sm text-gray-700">Available for sale</label>
                        </div>
                        <button type="submit" class="w-full bg-orange-600 text-white py-2 rounded-lg font-semibold hover:bg-orange-700 transition">
                            Add Listing
                        </button>
                    </form>
                </div>
            </div>

            <!-- Right Column: Orders & Listings -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Incoming Orders -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <span>üì•</span> Recent Orders
                    </h2>
                    <div id="ordersContainer" class="space-y-3">
                        <p class="text-gray-400 text-sm">No orders yet.</p>
                    </div>
                </div>

                <!-- Current Listings -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <span>üçΩÔ∏è</span> My Listings
                    </h2>
                    <div id="myListingsContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <p class="text-gray-400 text-sm">No listings active.</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://irtkpsukztkhacafzuoh.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_68PM__9-_Kaiu3hfxgAxdQ_3noCnxzu';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Elements
        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('appContainer');
        const authError = document.getElementById('authError');

        // Check Session on Load
        async function checkSession() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                showDashboard(session.user);
            } else {
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        }

        // Auth Handlers
        async function handleLogin() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const { error } = await _supabase.auth.signInWithPassword({ email, password });
            if (error) return showError(error.message);
            location.reload();
        }

        async function handleSignUp() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const { error } = await supabase.auth.signUp({ 
                email, 
                password,
                options: { data: { full_name: 'New Seller' } } // Simplified for demo
            });
            if (error) return showError(error.message);
            showError('Check your email to confirm your account!');
        }

        async function handleLogout() {
            await _supabase.auth.signOut();
            location.reload();
        }

        function showError(msg) {
            authError.innerText = msg;
            authError.classList.remove('hidden');
        }

        // Dashboard Logic
        async function showDashboard(user) {
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            document.getElementById('userEmail').innerText = user.email;

            loadMyListings(user.id);
            loadMyOrders(user.id);

            // Real-time Orders Listener
            _supabase.channel('orders-channel')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'orders', filter: `seller_id=eq.${user.id}` }, payload => {
                    console.log('New Order!', payload.new);
                    loadMyOrders(user.id); // Refresh list
                    // Optional: Show a browser notification
                    if (Notification.permission === 'granted') {
                        new Notification('New Order Received!', { body: `Order for listing ID: ${payload.new.listing_id}` });
                    }
                })
                .subscribe();
        }

        // Load Listings
        async function loadMyListings(seller_id) {
            const { data } = await supabase.from('listings').select('*').eq('seller_id', seller_id);
            const container = document.getElementById('myListingsContainer');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">You have no listings yet.</p>';
                return;
            }

            container.innerHTML = data.map(item => `
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-100">
                    <img src="${item.image_url || 'https://via.placeholder.com/100'}" class="w-16 h-16 object-cover rounded-md">
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800">${item.title}</h4>
                        <p class="text-sm text-gray-500">$${item.price}</p>
                    </div>
                    <span class="text-xs px-2 py-1 rounded-full ${item.is_available ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-600'}">
                        ${item.is_available ? 'Active' : 'Hidden'}
                    </span>
                </div>
            `).join('');
        }

        // Load Orders
        async function loadMyOrders(seller_id) {
            const { data } = await _supabase
                .from('orders')
                .select('*, listings(title)')
                .eq('seller_id', seller_id)
                .order('created_at', { ascending: false });
            
            const container = document.getElementById('ordersContainer');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">No orders yet.</p>';
                return;
            }

            container.innerHTML = data.map(o => `
                <div class="p-4 border border-gray-200 rounded-lg flex justify-between items-center">
                    <div>
                        <h4 class="font-semibold text-gray-800">${o.listings?.title || 'Deleted Item'}</h4>
                        <p class="text-sm text-gray-500">${o.customer_name} (${o.customer_phone})</p>
                        <p class="text-xs text-gray-400 mt-1">${new Date(o.created_at).toLocaleString()}</p>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-orange-600">$${o.total_price}</div>
                        <span class="text-xs px-2 py-1 rounded-full ${
                            o.status === 'pending' ? 'bg-yellow-100 text-yellow-700' : 
                            o.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'
                        }">${o.status}</span>
                    </div>
                </div>
            `).join('');
        }

        // Add Listing Form
        document.getElementById('listingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = (await _supabase.auth.getUser()).data.user;
            const form = e.target;
            const title = form.title.value;
            const price = form.price.value;
            const description = form.description.value;
            const is_available = form.is_available.checked;
            const imageFile = document.getElementById('foodImage').files[0];

            let imageUrl = null;

            // 1. Upload Image if selected
            if (imageFile) {
                const fileExt = imageFile.name.split('.').pop();
                const fileName = `${Math.random()}.${fileExt}`;
                const filePath = `food-images/${fileName}`;

                let { error: uploadError } = await supabase.storage
                    .from('food-images')
                    .upload(filePath, imageFile);

                if (uploadError) {
                    alert('Error uploading image');
                    return;
                }

                const { data: { publicUrl } } = supabase.storage.from('food-images').getPublicUrl(filePath);
                imageUrl = publicUrl;
            }

            // 2. Insert Listing
            const { error } = await _supabase.from('listings').insert([{
                title, price, description, image_url: imageUrl, is_available, seller_id: user.id
            }]);

            if (error) {
                alert('Error creating listing: ' + error.message);
            } else {
                form.reset();
                loadMyListings(user.id);
                alert('Listing added!');
            }
        });

        // Init
        checkSession();
    </script>
</body>
</html>
